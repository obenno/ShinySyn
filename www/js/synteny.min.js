var width=800,height=width,fontSize=10,tooltipDelay=800,formatValue=d3.format(".2~s"),heatmapMargin={top:10,right:0,bottom:20,left:0},microSyntenyMargin={top:5,right:0,bottom:10,left:0},microSyntenyHeight=400,heatmapHeight=30;Shiny.addCustomMessageHandler("plotMacroSynteny",plotMacroSynteny);var querySpecies=null,subjectSpecies=null,ribbonEnterTime=null,ribbonOutTime=null;function plotMacroSynteny(t){console.log(t);var e=convertShinyData(t.queryChrInfo),a=convertShinyData(t.subjectChrInfo),r=convertShinyData(t.ribbon);let n=t.queryChrColor,l=t.subjectChrColor,o=t.ribbonColor;querySpecies=t.querySpecies,subjectSpecies=t.subjectSpecies,r.sort(function(t,e){return e.queryEnd-e.queryStart-(t.queryEnd-t.queryStart)}),console.log(n),console.log(l);var c=d3.quantize(d3.interpolateRgb.gamma(2.2)(n,l),e.length+a.length);if("circular"===t.plotMode){let t=800,n=t,l=.5*Math.min(t,n)-60,d=l-10,m=5/d;d3.select("#macroSyntenyBlock").select("svg").remove(),d3.select("#geneDensityBlock").select("svg").remove(),d3.select("#microSyntenyBlock").select("svg").remove();const h=d3.select("#macroSyntenyBlock").append("svg").attr("viewBox",[-t/2,-n/2,t,n]);e=calc_circular_angle(e,Math.PI,2*Math.PI,m),console.log(e);var i=d3.tickStep(0,d3.sum(e.map(t=>t.value)),40);e.forEach(t=>{const e=(t.endAngle-t.startAngle-t.padAngle)/t.value;t.tickData=d3.range(0,t.value,i).map(a=>({value:a,angle:a*e+t.startAngle+t.padAngle/2}))}),a=calc_circular_angle(a,0,Math.PI,m);var s=d3.tickStep(0,d3.sum(a.map(t=>t.value)),40);a.forEach(t=>{const e=(t.endAngle-t.startAngle-t.padAngle)/t.value;t.tickData=d3.range(0,t.value,s).map(a=>({value:a,angle:a*e+t.startAngle+t.padAngle/2}))}),r.forEach(t=>{t.ribbonAngle={};let r=e.filter(e=>e.data.chr===t.queryChr)[0],n=a.filter(e=>e.data.chr===t.subjectChr)[0];const l=d3.scaleLinear().domain([r.data.start,r.data.end]).range([r.startAngle+r.padAngle/2,r.endAngle-r.padAngle/2]),o=d3.scaleLinear().domain([n.data.start,n.data.end]).range([n.startAngle+n.padAngle/2,n.endAngle-n.padAngle/2]),c={startAngle:l(t.queryStart),endAngle:l(t.queryEnd)},i={startAngle:o(t.subjectStart),endAngle:o(t.subjectEnd)};"+"===t.orientation?t.ribbonAngle={source:{startAngle:c.startAngle,endAngle:c.endAngle},target:{startAngle:i.startAngle,endAngle:i.endAngle}}:t.ribbonAngle={source:{startAngle:c.startAngle,endAngle:c.endAngle},target:{startAngle:i.endAngle,endAngle:i.startAngle}}});var u=d3.arc().innerRadius(d).outerRadius(l);const g=h.append("g").attr("class","macroQueryArc").attr("font-size",fontSize).attr("font-family","sans-serif").selectAll("g").data(e).join("g");g.append("path").attr("fill",t=>c[t.index]).attr("d",t=>u(t)).attr("data-tippy-content",t=>"Query: "+t.data.chr).on("mouseover",(t,e)=>{ribbonEnterTime=(new Date).getTime(),d3.selectAll(".from_"+e.data.chr).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",(t,e)=>{(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.selectAll(".from_"+e.data.chr).transition().duration(50).style("fill",o)}),g.append("path").attr("id",t=>"queryGroup"+t.index).attr("fill","none").attr("d",t=>{let e=/(^.+?)L/.exec(u(t))[1];if(e=e.replace(/,/g," "),t.endAngle>90*Math.PI/180&&t.endAngle<270*Math.PI/180){let t=/M(.*?)A(.*?)0 0 1 (.*?)$/;if(e.match(t)){let t=/M(.*?)A/,a=/A(.*?)0 0 1/,r=/0 0 1 (.*?)$/.exec(e)[1],n=t.exec(e)[1];e="M"+r+"A"+a.exec(e)[1]+"0 0 0 "+n}}return e}),g.append("text").attr("dy",function(t,e){return t.endAngle>90*Math.PI/180&&t.endAngle<270*Math.PI/180?35:-28}).append("textPath").attr("startOffset","50%").style("text-anchor","middle").attr("xlink:href",t=>"#queryGroup"+t.index).attr("class","queryChrLabel").text(t=>t.data.chr);const y=g.append("g").selectAll("g").data(t=>t.tickData).join("g").attr("transform",t=>`rotate(${180*t.angle/Math.PI-90}) translate(${l},0)`);y.append("line").attr("stroke","currentColor").attr("x2",4),y.append("text").attr("x",11).attr("dy","0.35em").attr("transform",t=>t.angle>Math.PI?"rotate(180) translate(-16)":null).attr("text-anchor",t=>t.angle>Math.PI?"end":null).text(t=>formatValue(t.value)).attr("font-size","8").attr("font-family","sans-serif");const p=h.append("g").attr("class","macroSubjectArc").attr("font-size",fontSize).attr("font-family","sans-serif").selectAll("g").data(a).join("g");p.append("path").attr("fill",t=>c[e.length+a.length-t.index-1]).attr("d",u).attr("data-tippy-content",t=>"Subject: "+t.data.chr).on("mouseover",(t,e)=>{ribbonEnterTime=(new Date).getTime(),d3.selectAll(".to_"+e.data.chr).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",(t,e)=>{(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.selectAll(".to_"+e.data.chr).transition().duration(50).style("fill",o)}),p.append("path").attr("id",t=>"subjectGroup"+t.index).attr("fill","none").attr("d",t=>{let e=/(^.+?)L/.exec(u(t))[1];if(e=e.replace(/,/g," "),t.startAngle>90*Math.PI/180&&t.startAngle<270*Math.PI/180){let t=/M(.*?)A(.*?)0 0 1 (.*?)$/;if(e.match(t)){let t=/M(.*?)A/,a=/A(.*?)0 0 1/,r=/0 0 1 (.*?)$/.exec(e)[1],n=t.exec(e)[1];e="M"+r+"A"+a.exec(e)[1]+"0 0 0 "+n}}return e}),p.append("text").attr("dy",function(t,e){return t.startAngle>90*Math.PI/180&&t.startAngle<270*Math.PI/180?35:-28}).append("textPath").attr("startOffset","50%").style("text-anchor","middle").attr("xlink:href",t=>"#subjectGroup"+t.index).attr("class","subjectChrLabel").text(t=>t.data.chr);const b=p.append("g").selectAll("g").data(t=>t.tickData).join("g").attr("transform",t=>`rotate(${180*t.angle/Math.PI-90}) translate(${l},0)`);b.append("line").attr("stroke","currentColor").attr("x2",4),b.append("text").attr("x",5).attr("dy","0.35em").attr("transform",t=>t.angle>Math.PI?"rotate(180) translate(-16)":null).attr("text-anchor",t=>t.angle>Math.PI?"end":null).text(t=>formatValue(t.value)).attr("font-size","8").attr("font-family","sans-serif"),h.append("g").attr("class","macroRibbons").selectAll("g").data(r).join("g").append("path").attr("fill",o).attr("opacity",.6).attr("d",t=>ribbon(t.ribbonAngle,d)).attr("class",t=>"from_"+t.queryChr+" to_"+t.subjectChr).attr("data-tippy-content",t=>"<b>Query:</b> "+t.q_startGene+" : "+t.q_endGene+"&#8594<b>Subject:</b> "+t.s_startGene+" : "+t.s_endGene).on("mouseover",function(){ribbonEnterTime=(new Date).getTime(),d3.select(this).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",function(){(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.select(this).transition().duration(50).style("fill",o)}).on("click",function(){const t=d3.select(this).data(),e=t[0].queryChr,a=t[0].queryStart,r=t[0].queryEnd,n=t[0].subjectChr,l=t[0].subjectStart,o=t[0].subjectEnd;Shiny.setInputValue("selected_macroRegion",{macroQueryChr:e,macroQueryStart:a,macroQueryEnd:r,macroSubjectChr:n,macroSubjectStart:l,macroSubjectEnd:o})});h.append("text").attr("class","querySyntenyLabel").attr("font-size",18).attr("font-family","sans-serif").attr("font-weight","bold").text(querySpecies).attr("transform",`translate(${-t/2+10}, ${40-n/2})`),h.append("text").attr("class","subjectSyntenyLabel").attr("font-size",18).attr("font-family","sans-serif").attr("font-weight","bold").text(subjectSpecies).attr("text-anchor","end").attr("transform",`translate(${t/2-10}, ${40-n/2})`)}else if("parallel"===t.plotMode){d3.select("#macroSyntenyBlock").select("svg").remove(),d3.select("#geneDensityBlock").select("svg").remove(),d3.select("#microSyntenyBlock").select("svg").remove();let t=800,c=400,i=10,s=20,u=15,d=5,m=10,h=20,g=10,y=10;const p=d3.select("#macroSyntenyBlock").append("svg").attr("viewBox",[0,0,t,c]),b=d3.scaleLinear().domain([0,1]).range([0,t-g-y-2*s]);e=calc_accumulate_len(e,b,i),a=calc_accumulate_len(a,b,i);const f=p.append("g").attr("class","macroQueryGroup"),x=p.append("g").attr("class","macroSubjectGroup"),_=d3.scaleLinear().domain([e[0].accumulate_start,e[e.length-1].accumulate_end]).range([0+g+s,t-y-s]),S=d3.scaleLinear().domain([a[0].accumulate_start,a[a.length-1].accumulate_end]).range([0+g+s,t-y-s]);f.append("text").text(querySpecies).attr("id","queryMainLabel").attr("x",0+g).attr("y",m+d3.select("#queryMainLabel").node().getBBox().height).attr("font-weight","bold").attr("font-size","1.2rem").attr("font-family","sans-serif"),f.selectAll("text").filter(":not(#queryMainLabel)").data(e).join("text").text(t=>t.chr).attr("text-anchor","middle").attr("x",t=>d3.mean([_(t.accumulate_end),_(t.accumulate_start)])).attr("y",function(){return Number(d3.select("#queryMainLabel").attr("y"))+Number(5)+Number(d3.select(this).node().getBBox().height)}).attr("font-weight","bold").attr("font-size","1rem").attr("font-family","sans-serif").attr("class","queryChrLabel"),f.selectAll("rect").data(e).join("rect").attr("class","queryChrShape").attr("id",t=>"queryChr_"+t.idx).attr("x",t=>_(t.accumulate_start)).attr("y",m+d3.select("#queryMainLabel").node().getBBox().height+5+d3.selectAll(".macroQueryGroup text").filter(":not(#queryMainLabel)").node().getBBox().height+5).attr("width",t=>_(t.accumulate_end)-_(t.accumulate_start)).attr("height",u).attr("stroke","black").attr("stroke-width",2).attr("opacity",.8).attr("fill",n).attr("ry",d).attr("data-tippy-content",t=>"Query: "+t.chr).on("mouseover",(t,e)=>{ribbonEnterTime=(new Date).getTime(),d3.selectAll(".from_"+e.chr).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",(t,e)=>{(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.selectAll(".from_"+e.chr).transition().duration(50).style("fill",o)}),x.append("text").text(subjectSpecies).attr("id","subjectMainLabel").attr("x",0+g).attr("y",c-h).attr("font-weight","bold").attr("font-size","1.2rem").attr("font-family","sans-serif"),x.selectAll("text").filter(":not(#subjectMainLabel)").data(a).join("text").text(t=>t.chr).attr("text-anchor","middle").attr("x",t=>d3.mean([S(t.accumulate_end),S(t.accumulate_start)])).attr("y",d3.select("#subjectMainLabel").attr("y")-d3.select("#subjectMainLabel").node().getBBox().height-5).attr("font-weight","bold").attr("font-size","1rem").attr("font-family","sans-serif").attr("class","subjectChrLabel"),x.selectAll("rect").data(a).join("rect").attr("id",t=>"subjectChr_"+t.idx).attr("x",t=>S(t.accumulate_start)).attr("y",c-h-d3.select("#subjectMainLabel").node().getBBox().height-5-d3.selectAll(".macroSubjectGroup text").filter(":not(#subjectMainLabel)").node().getBBox().height-5-u).attr("width",t=>S(t.accumulate_end)-S(t.accumulate_start)).attr("height",u).attr("stroke","black").attr("stroke-width",2).attr("opacity",.8).attr("fill",l).attr("ry",d).attr("data-tippy-content",t=>"Subject: "+t.chr).on("mouseover",(t,e)=>{ribbonEnterTime=(new Date).getTime(),d3.selectAll(".to_"+e.chr).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",(t,e)=>{(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.selectAll(".to_"+e.chr).transition().duration(50).style("fill",o)}),r.forEach(t=>{let r=e.find(e=>e.chr===t.queryChr),n=a.find(e=>e.chr===t.subjectChr),l=r.accumulate_start+t.queryStart-r.start+1,o=r.accumulate_start+t.queryEnd-r.start+1,i=n.accumulate_start+t.subjectStart-n.start+1,s=n.accumulate_start+t.subjectEnd-n.start+1;"+"===t.orientation?t.ribbonPosition={source:{x:_(l),x1:_(o),y:m+d3.select("#queryMainLabel").node().getBBox().height+5+d3.selectAll(".macroQueryGroup text").filter(":not(#queryMainLabel)").node().getBBox().height+5+u,y1:m+d3.select("#queryMainLabel").node().getBBox().height+5+d3.selectAll(".macroQueryGroup text").filter(":not(#queryMainLabel)").node().getBBox().height+5+u},target:{x:S(i),x1:S(s),y:c-h-d3.select("#subjectMainLabel").node().getBBox().height-5-d3.selectAll(".macroSubjectGroup text").filter(":not(#subjectMainLabel)").node().getBBox().height-5-u,y1:c-h-d3.select("#subjectMainLabel").node().getBBox().height-5-d3.selectAll(".macroSubjectGroup text").filter(":not(#subjectMainLabel)").node().getBBox().height-5-u}}:t.ribbonPosition={source:{x:_(l),x1:_(o),y:m+d3.select("#queryMainLabel").node().getBBox().height+5+d3.selectAll(".macroQueryGroup text").filter(":not(#queryMainLabel)").node().getBBox().height+5+u,y1:m+d3.select("#queryMainLabel").node().getBBox().height+5+d3.selectAll(".macroQueryGroup text").filter(":not(#queryMainLabel)").node().getBBox().height+5+u},target:{x:S(s),x1:S(i),y:c-h-d3.select("#subjectMainLabel").node().getBBox().height-5-d3.selectAll(".macroSubjectGroup text").filter(":not(#subjectMainLabel)").node().getBBox().height-5-u,y1:c-h-d3.select("#subjectMainLabel").node().getBBox().height-5-d3.selectAll(".macroSubjectGroup text").filter(":not(#subjectMainLabel)").node().getBBox().height-5-u}}});p.append("g").attr("class","macroRibbons").selectAll("path").data(r).join("path").attr("d",t=>createLinkPolygonPath(t.ribbonPosition)).attr("class",t=>"from_"+t.queryChr+" to_"+t.subjectChr).attr("fill",o).attr("opacity",.6).attr("data-tippy-content",t=>"<b>Query:</b> "+t.q_startGene+" : "+t.q_endGene+"&#8594<b>Subject:</b> "+t.s_startGene+" : "+t.s_endGene).on("mouseover",function(){ribbonEnterTime=(new Date).getTime(),d3.select(this).transition().delay(tooltipDelay).duration(50).style("fill","red")}).on("mouseout",function(){(ribbonOutTime=(new Date).getTime())-ribbonEnterTime<=8e3&&d3.select(this).transition().duration(50).style("fill",o)}).on("click",function(){const t=d3.select(this).data(),e=t[0].queryChr,a=t[0].queryStart,r=t[0].queryEnd,n=t[0].subjectChr,l=t[0].subjectStart,o=t[0].subjectEnd;Shiny.setInputValue("selected_macroRegion",{macroQueryChr:e,macroQueryStart:a,macroQueryEnd:r,macroSubjectChr:n,macroSubjectStart:l,macroSubjectEnd:o})})}tippy(".macroQueryArc path",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".macroSubjectArc path",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".macroQueryGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".macroSubjectGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".macroRibbons path",{trigger:"mouseenter",followCursor:"initial",allowHTML:!0,delay:[tooltipDelay,null]}),downloadSVG("marcoSynteny_download","macroSyntenyBlock"),downloadSVGwithForeign("dotView_download","dotView")}function calc_circular_angle(t,e,a,r){return d3.pie().sort(null).sortValues(null).startAngle(e).endAngle(a).padAngle(r).value(t=>t.chrLength)(t)}function calc_accumulate_len(t,e,a){let r=0,n=d3.sum(t.map(t=>t.chrLength)),l=e.invert(a);return t.forEach((t,e)=>{t.idx=e,t.accumulate_start=r+1,t.accumulate_end=t.accumulate_start+t.chrLength-1,r=t.accumulate_end+n*l}),t}function convertShinyData(t){const e=Object.keys(t);let a=[];for(let r=0;r<t[e[0]].length;r++){a[r]={};for(let n=0;n<e.length;n++)a[r][e[n]]=t[e[n]][r]}return a}function ribbon(t,e){return ribbonCustom(t,e-1,1/e)}function ribbonCustom(t,e,a){t.source,t.target;let r=e,n=e,l=d3.path(),o=Math.PI/2,c=a/2,i=+r,s=t.source.startAngle-o,u=t.source.endAngle-o,d=+n,m=t.target.startAngle-o,h=t.target.endAngle-o;return c>Math.epsilon&&(Math.abs(u-s)>2*c+Math.epsilon?u>s?(s+=c,u-=c):(s-=c,u+=c):s=u=(s+u)/2,Math.abs(h-m)>2*c+Math.epsilon?h>m?(m+=c,h-=c):(m-=c,h+=c):m=h=(m+h)/2),l.moveTo(i*Math.cos(s),i*Math.sin(s)),l.arc(0,0,i,s,u),s===m&&u===h||(l.quadraticCurveTo(0,0,d*Math.cos(m),d*Math.sin(m)),m<h?l.arc(0,0,d,m,h):l.arc(0,0,d,m,h,!0)),l.quadraticCurveTo(0,0,i*Math.cos(s),i*Math.sin(s)),l.closePath(),l._}Shiny.addCustomMessageHandler("plotSelectedMicroSynteny",plotSelectedMicroSynteny);var regionData=null,micro_queryBed=null,micro_subjectBed=null,forwardColor=null,reverseColor=null,microRibbonColor=null,brush=null,hScale=null;function plotSelectedMicroSynteny(t){forwardColor=t.microForwardColor,reverseColor=t.microReverseColor,microRibbonColor=t.microRibbonColor,(micro_queryBed=convertShinyData(t.microQueryRegion)).forEach((t,e)=>t.elementID="queryGene_"+e),(micro_subjectBed=convertShinyData(t.microSubjectRegion)).forEach((t,e)=>t.elementID="subjectGene_"+e);var e=convertShinyData(t.microAnchors);let a=micro_queryBed[0].start,r=micro_queryBed[micro_queryBed.length-1].end,n=r-a+1;hScale=d3.scaleLinear().domain([a,r]).range([0,width]),regionData=[];let l=null;l=micro_queryBed.length>1e3?Math.ceil(n/100):micro_queryBed.length>100?Math.ceil(n/50):micro_queryBed.length>50?Math.ceil(n/10):Math.ceil(n/5);for(let t=a;t<=r;t+=l)regionData.push({start:t,end:d3.min([r,t+l-1]),queryGenes:[],anchors:[],pathData:[]});regionData.forEach(t=>{micro_queryBed.forEach((e,a)=>{e.start>=t.start&&e.start<=t.end&&t.queryGenes.push(e)}),e.forEach(e=>{e.q_GeneStart>=t.start&&e.q_GeneStart<=t.end&&"."!=e.s_Gene&&micro_subjectBed.map(t=>t.gene).includes(e.s_Gene)&&(t.anchors.push(e),t.pathData.push({from:e.q_Gene,to:e.s_Gene,sourceElementID:"queryGene_"+micro_queryBed.findIndex(t=>t.gene===e.q_Gene),targetElementID:"subjectGene_"+micro_subjectBed.findIndex(t=>t.gene===e.s_Gene),sourceStrand:e.q_GeneStrand,targetStrand:e.s_GeneStrand}))})}),console.log(regionData);var o=d3.sum(regionData.map(t=>t.queryGenes.length));if(o<100)var c=regionData;else c=regionData.slice(regionData.length-4,regionData.length);let i=d3.scaleSequential(d3.interpolatePurples).domain([0,d3.max(regionData.map(t=>t.queryGenes.length))]);const s=d3.create("svg").attr("viewBox",[0,0,width,heatmapMargin.top+heatmapHeight+heatmapMargin.bottom]);s.append("g").attr("class","geneDensity").selectAll("rect").data(regionData).join("rect").attr("x",t=>hScale(t.start)).attr("y",0+heatmapMargin.top).attr("width",t=>hScale(t.end)-hScale(t.start)).attr("height",heatmapHeight).style("fill",t=>i(t.queryGenes.length)),brush=d3.brushX().extent([[heatmapMargin.left,heatmapMargin.top-5],[width-heatmapMargin.right,heatmapHeight+heatmapMargin.top+5]]).on("end",function(t){const e=t.selection;let a=[];if(!t.sourceEvent||!e)return;let r=null,n=null;const l=hScale.invert(e[1])-hScale.invert(e[0]);e[0]<hScale.range()[0]&&(e[0]=hScale.range()[0]);e[1]>hScale.range()[1]&&(e[1]=hScale.range()[1]);regionData.forEach((t,l)=>{hScale.invert(e[0])>=t.start&&hScale.invert(e[0])<=t.end&&(hScale.invert(e[0])>=t.start+(t.end-t.start)/2?r=t.end+1:(r=t.start,a.push(l))),hScale.invert(e[0])<t.start&&hScale.invert(e[1])>t.end&&a.push(l),hScale.invert(e[1])>=t.start&&hScale.invert(e[1])<=t.end&&(hScale.invert(e[1])>=t.start+(t.end-t.start)/2?(n=t.end,a.push(l)):n=t.start-1)}),l>5*(regionData[0].end-regionData[0].start+1)&&(n=r+5*(regionData[0].end-regionData[0].start+1));d3.select(this).transition().call(brush.move,n>r?[r,n].map(hScale):null),a.length>5&&(a=a.slice(0,5));d3.select("#microSyntenyBlock").select("svg").remove();const o=generate_microSytenySVG(c=a.map(t=>regionData[t]),micro_subjectBed,querySpecies,subjectSpecies,forwardColor,reverseColor,microRibbonColor,microSyntenyHeight,microSyntenyMargin,"microQueryGroup","microSubjectGroup","microRibbons");d3.select("#microSyntenyBlock").select("svg").remove(),d3.select("#microSyntenyBlock").append(()=>o.node()),tippy(".microQueryGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microSubjectGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microRibbons path",{trigger:"mouseenter",allowHTML:!0,followCursor:"initial",delay:[tooltipDelay,null]})});s.append("g").call(xAxis,hScale);let u=[hScale(regionData[regionData.length-5].start),hScale.range()[1]];s.append("g").attr("class","brush").call(brush).call(brush.move,u);d3.select("#geneDensityBlock").select("svg").remove(),d3.select("#microSyntenyBlock").select("svg").remove(),console.log(c),console.log(micro_subjectBed);const d=generate_microSytenySVG(c,micro_subjectBed,querySpecies,subjectSpecies,forwardColor,reverseColor,microRibbonColor,microSyntenyHeight,microSyntenyMargin,"microQueryGroup","microSubjectGroup","microRibbons");o>100&&d3.select("#geneDensityBlock").append(()=>s.node()),d3.select("#microSyntenyBlock").append(()=>d.node()),downloadSVG("microSynteny_download","microSyntenyBlock"),tippy(".microQueryGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microSubjectGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microRibbons path",{trigger:"mouseenter",allowHTML:!0,followCursor:"initial",delay:[tooltipDelay,null]})}function plot_microSyntenyGenes(t,e,a,r,n,l,o){const c=t.append("g").attr("class",o);return c.append("line").attr("x1",0).attr("y1",r).attr("x2",width).attr("y2",r).style("stroke","grey").style("stroke-width","5"),c.selectAll("rect").data(e).join("rect").attr("id",t=>t.elementID).attr("x",t=>a(t.start)).attr("y",r-10).attr("width",function(t){return a(t.end)-a(t.start)}).attr("height",20).style("fill",t=>"+"===t.strand?n:l).attr("data-tippy-content",t=>t.gene),c.selectAll("rect").on("mouseover",function(){d3.select(this).transition().duration(50).delay(tooltipDelay).style("stroke-width","2").style("stroke","black")}).on("mouseout",function(){d3.select(this).transition().duration(50).style("stroke-width",null).style("stroke",null)}),c.node()}function createLinkLinePath(t){let e=[[t.source.x,t.source.y],[t.target.x,t.target.y],[t.target.x1,t.target.y1],[t.source.x1,t.source.y1]];return d3.line()(e)}function createPath(t,e,a,r="ribbons"){const n=[];e.forEach(function(e,a){"."!=e.to&&n.push(extractRectPointData(t,e.from,e.to,e.sourceElementID,e.targetElementID,e.sourceStrand,e.targetStrand))}),console.log(n);const l=t.append("g").attr("class",r);return l.selectAll("path").data(n).join("path").attr("d",function(t,e){return createLinkPolygonPath(t)}).attr("fill",a).style("mix-blend-mode","multiply").style("fill-opacity",.6).attr("data-tippy-content",t=>t.pathTitle),l.selectAll("path").on("mouseover",function(){d3.select(this).transition().delay(tooltipDelay).duration(50).style("fill-opacity",.86);let t=this.__data__.source.id,e=this.__data__.target.id;d3.select("#"+t).transition().delay(tooltipDelay).duration(50).style("stroke-width","2").style("stroke","black"),d3.select("#"+e).transition().delay(tooltipDelay).duration(50).style("stroke-width","2").style("stroke","black")}).on("mouseout",function(){d3.select(this).transition().duration(50).style("fill-opacity",.6);let t=this.__data__.source.id,e=this.__data__.target.id;d3.select("#"+t).transition().duration(50).style("stroke-width",null).style("stroke",null),d3.select("#"+e).transition().duration(50).style("stroke-width",null).style("stroke",null)}),l.node()}function extractRectPointData(t,e,a,r,n,l,o){const c=t.select("#"+r),i=t.select("#"+n);let s=Number(c.attr("x")),u=Number(c.attr("y")),d=Number(c.attr("height")),m=Number(c.attr("width")),h=Number(i.attr("x")),g=Number(i.attr("y")),y=(Number(i.attr("height")),Number(i.attr("width")));if(l===o)var p={source:{x:s,y:u+d,x1:s+m,y1:u+d,id:r},target:{x:h,y:g,x1:h+y,y1:g,id:n},pathTitle:e+"("+l+") &#8594"+a+"("+o+")"};else p={source:{x:s,y:u+d,x1:s+m,y1:u+d,id:r},target:{x:h+y,y:g,x1:h,y1:g,id:n},pathTitle:e+"("+l+") &#8594"+a+"("+o+")"};return p}function createLinkPolygonPath(t){let e=t.source.x,a=t.target.x,r=t.source.y,n=t.target.y,l=d3.interpolateNumber(r,n),o=l(.45),c=l(.55),i=t.target.x1,s=t.source.x1,u=d3.interpolateNumber(n,r);return"M"+e+","+r+"C"+e+","+o+" "+a+","+c+" "+a+","+n+"L"+i+","+n+"C"+i+","+u(.45)+" "+s+","+u(.55)+" "+s+","+r}function getRegionBoundary(t){let e=t.map(t=>t.start).sort((t,e)=>t-e),a=t.map(t=>t.end).sort((t,e)=>t-e);return[e[0],a[a.length-1]]}let xAxis=(t,e)=>t.attr("transform",`translate(0,${heatmapMargin.top+heatmapHeight})`).call(t=>t.append("g").call(d3.axisBottom(e).ticks(width/50,",.3~s").tickSize(4).tickPadding(2)).attr("text-anchor","end").call(t=>t.select(".domain").remove()).call(t=>t.selectAll("text").attr("x",6)));function queryAxis(t,e){t.call(t=>t.call(d3.axisTop(e).ticks(width/60,",.3~s").tickSize(4).tickPadding(2)).attr("text-anchor","end").call(t=>t.select(".domain").remove()).call(t=>t.selectAll("text").attr("x",6)))}function subjectAxis(t,e){t.call(t=>t.call(d3.axisBottom(e).ticks(width/60,",.3~s").tickSize(4).tickPadding(2)).attr("text-anchor","end").call(t=>t.select(".domain").remove()).call(t=>t.selectAll("text").attr("x",6)))}function generate_microSytenySVG(t,e,a,r,n,l,o,c,i,s="queryGroup",u="subjectGroup",d="ribbons"){const m=d3.create("svg").attr("viewBox",[0,0,width,c]);let h=t.map(t=>t.queryGenes).flat();console.log(h);let g=t.map(t=>t.pathData).flat(),y=null,p=null,b=null,f=null,x=null,_=null,S=d3.min(t.map(t=>t.anchors.map(t=>t.s_GeneStart).flat()).flat()),w=d3.max(t.map(t=>t.anchors.map(t=>t.s_GeneEnd).flat()).flat()),A=[];console.log(e),e.forEach(t=>{t.start>=S&&t.start<=w&&A.push({gene:t.gene,chr:t.chr,start:t.start,end:t.end,strand:t.strand,elementID:t.elementID})}),console.log(A);let v=i.top+40+10,j=c-i.bottom-50;const q=m.append("text").attr("class","queryChrLabel").attr("font-size",12).attr("font-family","sans-serif").attr("font-weight","bold").attr("transform",`translate(0, ${i.top+10})`),D=m.append("text").attr("class","queryChrLabel").attr("font-size",12).attr("font-family","sans-serif").attr("font-weight","bold").attr("transform",`translate(0, ${j+50})`),M=m.append("g").attr("class","queryAxis").attr("transform",`translate(0, ${v-20})`),B=m.append("g").attr("class","subjectAxis").attr("transform",`translate(0, ${j+20})`);q.text(a+": "+h[0].chr),[b,f]=getRegionBoundary(h),x=f-b+1,y=d3.scaleLinear().domain([b-.025*x,f+.025*x]).range([0,width]),m.append(()=>plot_microSyntenyGenes(m,h,y,v,n,l,s)),D.text(r+": "+A[0].chr),[S,w]=getRegionBoundary(A),_=w-S+1,p=d3.scaleLinear().domain([S-.025*_,w+.025*_]).range([0,width]),m.append(()=>plot_microSyntenyGenes(m,A,p,j,n,l,u)),m.append(()=>createPath(m,g,o,d)),M.call(queryAxis,y),B.call(subjectAxis,p);const C=d3.zoom().extent([[0,0],[width,c]]).scaleExtent([1,10]).translateExtent([[0,-1/0],[width,1/0]]).on("zoom",function(t){const e=t.transform.rescaleX(y),a=t.transform.rescaleX(p);m.select("."+s).selectAll("rect").attr("x",t=>e(t.start)).attr("width",function(t){return e(t.end)-e(t.start)}),m.select("."+u).selectAll("rect").attr("x",t=>a(t.start)).attr("width",function(t){return a(t.end)-a(t.start)}),m.select("."+d).remove(),m.append(()=>createPath(m,g,o,d)),M.call(queryAxis,e),B.call(subjectAxis,a)}).on("end",function(){tippy("."+d+" path",{trigger:"mouseenter",allowHTML:!0,followCursor:"initial",delay:[tooltipDelay,null]})});return m.call(C),m}function serialize(t){const e="http://www.w3.org/2000/xmlns/";t=t.cloneNode(!0);const a=window.location.href+"#",r=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);for(;r.nextNode();)for(const t of r.currentNode.attributes)t.value.includes(a)&&(t.value=t.value.replace(a,"#"));t.setAttributeNS(e,"xmlns","http://www.w3.org/2000/svg"),t.setAttributeNS(e,"xmlns:xlink","http://www.w3.org/1999/xlink");const n=(new window.XMLSerializer).serializeToString(t);return new Blob([n],{type:"image/svg+xml"})}function downloadSVG(t,e){d3.select("#"+t).on("click",function(t){const a=d3.select("#"+e).select("svg").node(),r=URL.createObjectURL(serialize(a));d3.select(this).attr("download","output.svg").attr("href",r)})}function createSvgSnapshot(t){const e=t.cloneNode(!0),a=Array.from(t.querySelectorAll("canvas")),r=Array.from(e.querySelectorAll("canvas"));if(a.length!==r.length)throw Error("Canvas mismatch");a.map((t,e)=>{const a=document.createElement("img");for(let e of["width","height"])a.setAttribute(e,t.getAttribute(e));a.src=t.toDataURL(),r[e].replaceWith(a)}),serializeString(e)}function serializeString(t){const e="http://www.w3.org/2000/xmlns/";t=t.cloneNode(!0);const a=window.location.href+"#",r=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null,!1);for(;r.nextNode();)for(const t of r.currentNode.attributes)t.value.includes(a)&&(t.value=t.value.replace(a,"#"));return t.setAttributeNS(e,"xmlns","http://www.w3.org/2000/svg"),t.setAttributeNS(e,"xmlns:xlink","http://www.w3.org/1999/xlink"),(new XMLSerializer).serializeToString(t)}function saveAs(t,e){var a=document.createElement("a");"string"==typeof a.download?(document.body.appendChild(a),a.download=e,a.href=t,a.click(),document.body.removeChild(a)):location.replace(t)}function downloadSVGwithForeign(t,e){d3.select("#"+t).on("click",function(t){const a=d3.select("#"+e).select("svg").node(),r=Array.from(a.querySelectorAll("canvas")),n="data:image/svg+xml; charset=utf8, "+encodeURIComponent(serializeString(a)),l=new Image;l.onload=()=>{const t=document.createElement("canvas"),e=a.getBoundingClientRect();t.width=4*e.width,t.height=4*e.height;const n=t.getContext("2d");n.fillStyle="#FAFAFA",n.fillRect(0,0,4*e.width,4*e.height),n.drawImage(l,0,0,4*e.width,4*e.height),r.map((t,a)=>{n.drawImage(t,0,0,4*e.width,4*e.height)}),saveAs(t.toDataURL("image/png"),"dotView.png")},l.src=n})}function plotDotView(t){var e=convertShinyData(t.queryChrInfo),a=convertShinyData(t.subjectChrInfo),r=convertShinyData(t.anchorSeed),n=t.querySpecies,l=t.subjectSpecies;console.log(e),console.log(a),console.log(r);let o=v(r);Shiny.setInputValue("selected_anchors",o);let c=660,i=660;const s=d3.scaleLinear().domain([0,1]).range([0,c-50-10-40]);e=calc_accumulate_len(e,s,0),a=calc_accumulate_len(a,s,0),r.forEach(t=>{let r=e.find(e=>e.chr===t.chr_query),n=a.find(e=>e.chr===t.chr_subject),l=d3.scaleLinear().domain([r.start,r.end]).range([r.accumulate_start,r.accumulate_end]),o=d3.scaleLinear().domain([n.start,n.end]).range([n.accumulate_start,n.accumulate_end]);t.accumulate_x=l(t.start_query),t.accumulate_y=o(t.start_subject)}),console.log(e),console.log(a),console.log(r),d3.select("#dotView").select("svg").remove();let u=[e[0].accumulate_start,e[e.length-1].accumulate_end],d=[a[0].accumulate_start,a[a.length-1].accumulate_end];const m=d3.scaleLinear().domain(u).range([50,c-10]),h=d3.scaleLinear().domain(d).range([i-50,10]),g=d3.axisBottom(m).tickValues(e.map(t=>t.accumulate_end).slice(0,-1)),y=d3.axisLeft(h).tickValues(a.map(t=>t.accumulate_end).slice(0,-1)),p=d3.create("canvas").attr("width",c).attr("height",i),b=p.node().getContext("2d");function f(t,e,a){b.beginPath(),b.fillStyle=a;const r=t,n=e;b.arc(r,n,1.2,0,2*Math.PI,!0),b.fill()}r.forEach(t=>{f(m(t.accumulate_x),h(t.accumulate_y),"black")});const x=d3.select("#dotView").append("svg").attr("viewBox",[0,0,c,i]);x.append("foreignObject").attr("x","0").attr("y","0").attr("width","100%").attr("height","100%").append(()=>p.node()),x.append("g").attr("class","axis axis--x").attr("transform",`translate(0,${i-50})`).call(g).call(t=>t.selectAll(".tick text").remove()).call(t=>t.selectAll(".tick line").clone().attr("y2",60-i).attr("stroke-dasharray","4 1").attr("stroke-opacity",.5)),x.append("g").attr("class","axis axis--y").attr("transform","translate(50, 0)").call(y).call(t=>t.selectAll(".tick text").remove()).call(t=>t.selectAll(".tick line").clone().attr("x2",c-50-10).attr("stroke-dasharray","4 1").attr("stroke-opacity",.5)),x.append("g").append("line").attr("transform","translate(50, 10)").attr("x2",c-50-10).attr("stroke","currentColor").attr("stroke-opacity",1),x.append("g").append("line").attr("transform",`translate(${c-10}, 10)`).attr("y2",i-10-50).attr("stroke","currentColor").attr("stroke-opacity",1),x.append("g").attr("class","xLabel").selectAll("text").data(e).join("text").attr("x",t=>m(d3.mean([t.accumulate_start,t.accumulate_end]))).attr("y",i-50+20).attr("font-size","0.8rem").text(t=>t.chr).attr("text-anchor","middle"),x.append("g").attr("class","yLabel").attr("transform","translate(50, 10)").selectAll("g").data(a).join("g").attr("transform",t=>`translate(-15 ${h(d3.mean([t.accumulate_start,t.accumulate_end]))})`).append("text").attr("font-size","0.8rem").text(t=>t.chr).attr("text-anchor","middle").attr("transform",function(){return"rotate(-90)"}),x.append("g").attr("class","xTitle").append("text").attr("x",d3.mean([50,c-10])).attr("y",i-50+40).attr("text-anchor","middle").attr("font-size","1rem").attr("font-weight","bold").text(n),x.append("g").attr("class","yTitle").append("text").attr("y",d3.mean([10,i-50])).attr("x",15).attr("text-anchor","middle").attr("font-size","1rem").attr("font-weight","bold").attr("transform",function(){return`rotate(-90, ${d3.select(this).attr("x")}, ${d3.select(this).attr("y")})`}).text(l);let _,S=d3.brush().extent([[50,10],[c-10,i-50]]).on("end",function({selection:t}){let e=t;if(e)m.domain([e[0][0],e[1][0]].map(m.invert,m)),h.domain([e[1][1],e[0][1]].map(h.invert,h)),x.select(".brush").call(S.move,null);else{if(!_)return _=setTimeout(A,w);m.domain(u),h.domain(d)}!function(){var t=x.transition().duration(750);x.select(".axis--x").transition(t).call(g),x.select(".axis--y").transition(t).call(y),x.select(".xLabel").selectAll("text").transition(t).attr("x",t=>t.accumulate_start<m.domain()[0]&&t.accumulate_end>m.domain()[0]&&t.accumulate_end<m.domain()[1]?m(d3.mean([m.domain()[0],t.accumulate_end])):t.accumulate_start<m.domain()[1]&&t.accumulate_start>m.domain()[0]&&t.accumulate_end>m.domain()[1]?m(d3.mean([t.accumulate_start,m.domain()[1]])):t.accumulate_start<m.domain()[0]&&t.accumulate_end>m.domain()[1]?d3.mean([m.range()[0],m.range()[1]]):m(d3.mean([t.accumulate_start,t.accumulate_end]))),x.select(".yLabel").selectAll("g").transition(t).attr("transform",t=>{let e;return`translate(-15 ${e=t.accumulate_start<h.domain()[0]&&t.accumulate_end>h.domain()[0]&&t.accumulate_end<h.domain()[1]?h(d3.mean([h.domain()[0],t.accumulate_end])):t.accumulate_start<h.domain()[1]&&t.accumulate_start>h.domain()[0]&&t.accumulate_end>h.domain()[1]?h(d3.mean([t.accumulate_start,h.domain()[1]])):t.accumulate_start<h.domain()[0]&&t.accumulate_end>h.domain()[1]?d3.mean([h.range()[0],h.range()[1]]):h(d3.mean([t.accumulate_start,t.accumulate_end]))})`});let e=[];b.save(),b.clearRect(0,0,c,i),r.forEach(t=>{t.accumulate_x>=m.domain()[0]&&t.accumulate_x<=m.domain()[1]&&t.accumulate_y>=h.domain()[0]&&t.accumulate_y<=h.domain()[1]&&(f(m(t.accumulate_x),h(t.accumulate_y),"black"),e.push(t))}),b.restore(),console.log(e);let a=v(e);Shiny.setInputValue("selected_anchors",a)}()}),w=350;function A(){_=null}function v(t){let e={queryGene:[],chr_query:[],start_query:[],end_query:[],strand_query:[],subjectGene:[],chr_subject:[],start_subject:[],end_subject:[],strand_subject:[],mcscan_score:[]};return t.forEach(t=>{e.queryGene.push(t.queryGene),e.chr_query.push(t.chr_query),e.start_query.push(t.start_query),e.end_query.push(t.end_query),e.strand_query.push(t.strand_query),e.subjectGene.push(t.subjectGene),e.chr_subject.push(t.chr_subject),e.start_subject.push(t.start_subject),e.end_subject.push(t.end_subject),e.strand_subject.push(t.strand_subject),e.mcscan_score.push(t.mcscan_score)}),e}x.append("g").attr("class","brush").call(S)}function updateChrFontSize(t){console.log(t),d3.selectAll("text.queryChrLabel,textPath.queryChrLabel").transition().attr("font-size",t),d3.selectAll("text.subjectChrLabel,textPath.subjectChrLabel").transition().attr("font-size",t)}Shiny.addCustomMessageHandler("center_microSynteny",function(t){console.log(t);let e=null,a=[];regionData.forEach((a,r)=>{a.queryGenes.some(e=>e.gene===t)&&(e=r)}),regionData.length<=5?regionData.map((t,e)=>a.push(e)):e>=3&&e<=regionData.length-3?(a.push(e-2),a.push(e-1),a.push(e),a.push(e+1),a.push(e+2)):e<3?a=[0,1,2,3,4]:e>regionData.length-3&&(a=[regionData.length-5,regionData.length-4,regionData.length-3,regionData.length-2,regionData.length-1]);const r=generate_microSytenySVG(a.map(t=>regionData[t]),micro_subjectBed,querySpecies,subjectSpecies,forwardColor,reverseColor,microRibbonColor,microSyntenyHeight,microSyntenyMargin,"microQueryGroup","microSubjectGroup","microRibbons");d3.select("#microSyntenyBlock").select("svg").remove(),d3.select("#microSyntenyBlock").append(()=>r.node()),tippy(".microQueryGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microSubjectGroup rect",{trigger:"mouseenter",followCursor:"initial",delay:[tooltipDelay,null]}),tippy(".microRibbons path",{trigger:"mouseenter",allowHTML:!0,followCursor:"initial",delay:[tooltipDelay,null]}),d3.select("#geneDensityBlock").select("svg").select(".brush").transition().call(brush.move,[regionData[a[0]].start,regionData[a[a.length-1]].end].map(hScale)),d3.select("#queryGene_"+micro_queryBed.findIndex(e=>e.gene===t)).style("fill","#FF5733")}),Shiny.addCustomMessageHandler("plotDotView",plotDotView),Shiny.addCustomMessageHandler("updateChrFontSize",updateChrFontSize);
